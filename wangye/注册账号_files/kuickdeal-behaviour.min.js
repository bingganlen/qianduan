webpackJsonpkuickDeal([2],{22:function(e,i,t){var o=t(5),n=t(9),a=t(2),r=t(11),d=t(23),s=a.selector(),u=t(12),a=t(17),c=t(6),l={},g=new d(o.appKey),m=15;l.run=function(){var e=this;n.info("behaviour run!"),e.init()},l.init=function(){function e(e,t){if(!e){g.set("view_log_id",t.id),i.view_log_id=t.id,n.debug("api请求到的view_log_id "+t.id);var o=t.heartbeat;isNaN(o)||(m=o),i.closeWindoUpdataTime_browse()}}var i=this;i.dealUser=JSON.parse(r.get("dealUser")),i.dealUserId=i.dealUser.id,i.accessToken=JSON.parse(r.get("token")).access_token,i.timeDifference=parseInt(r.get("differentTime")),i.keyBehaviourIds={},n.debug("behaviour 获取到的时差"+i.timeDifference),i.updataForVersions(),i.addPagIndex(),i.addWindowUnloadEvent(),i.needCreateVisit()?(n.debug("访问！"),i.makeVisitHistory(function(){i.makeBrowserHistory(e)})):(n.debug("浏览！"),i.makeBrowserHistory(e))},l.needCreateVisit=function(){function e(e){var i="",t={logId:0,dealId:1,customerId:2};try{var o=g.get("log_id").split(":");i=o[t[e]]}catch(i){n.debug("没有找到 "+e+" 的值！")}return i}var i=this,t=1;g.get("kuickDeal_pageIndex")&&(t=parseInt(g.get("kuickDeal_pageIndex")));var o=e("logId"),a=i.getLeaveTimeDValue(),r=e("dealId"),d=e("customerId"),s="";try{s=i.dealUser.customer.id}catch(e){n.debug("没有从当前页面中找到customer id！")}n.debug("准备判断生成访问记录还是浏览记录！"),n.debug("pageIndex----"+t),n.debug("leaveTime----"+a),n.debug("logId--------"+o),n.debug("dealUserId---"+i.dealUserId),n.debug("cookieDealId-"+r),n.debug("nowDealUserCustomerId---"+s),n.debug("cookieCustomerd-"+d);var u=g.get("log_id");u=u?u.split(":"):[];var c=!1;return u.length<3&&u.length>0?(n.debug("dealUser--流程！"),c=i.dealUserId!==r):(n.debug("customer--流程！"),c=""!==d&&""!==s&&d!==s),!!(1==t&&a||!o||c)||(i.log_id=o,!1)},l.makeVisitHistory=function(e){function i(i,o){if(!i){var a="";try{a=t.dealUser.customer.id}catch(e){n.debug("没有获取到customer id")}g.set("log_id",o.id+":"+t.dealUserId+":"+a),t.log_id=o.id,n.debug("获取到的api访问记录log_id -"+o.id),e&&e()}}var t=this,o=window.location.href,r=window.location.protocol,d=window.location.host,c=(s("title").text(),(new Date).format("yyyy-MM-dd hh:mm:ss")),l=document.referrer,m={site:r+"//"+d,when:c,clientName:a.name,clientVersion:a.version,os:a.osName,osVersion:a.osVersion,net:"WIFI",system:a.osName,referrer:l,url:o};u.behaviourLog.newVisitNotes(t.dealUserId,m,t.accessToken,i)},l.makeBrowserHistory=function(e){var i=this,t=encodeURI(window.location.href),o=(encodeURI(window.location.host),s("title").text()),r=((new Date).format("yyyy-MM-dd hh:mm:ss"),s("meta[name=identity]")),d=t;r.length>0?d=r.attr("content"):o&&(d=o);var c=i.log_id;g.get("log_id")&&(c=g.get("log_id").split(":")[0],i.log_id=c),n.debug("浏览记录中获取到的log_id - "+c);var l={url:t,title:o,identity:d,client:a.name,system:a.osName};u.behaviourLog.browseNotes(i.dealUserId,c,l,i.accessToken,e)},l.changeVisitEndTime=function(){var e=this,i=1e3*m;setInterval(function(){e.updataVisitTime(e,function(e,i){if(e)return void n.error(e)})},i)},l.changeBrowseNotesEndTime=function(){var e=this,i=1e3*m;setInterval(function(){e.updataBrowseEndTime(e,function(e,i){if(e)return void n.error(e)})},i)},l.closeWindoUpdataTime_visit=function(){var e=this;s(window).on("beforeunload",function(){e.updataVisitTime(e,function(e,i){if(e)return void n.error(e)})})},l.closeWindoUpdataTime_browse=function(){var e=this;s(window).on("beforeunload",function(){e.updataBrowseEndTime(e,function(e,i){if(e)return void n.error(e)})})},l.updataVisitTime=function(e,i){var e=this,t=e.log_id,o=e.timeDifference,n={},a=(new Date).getTime()+o,r=new Date(a).format("yyyy-MM-dd hh:mm:ss");n.endTime=r,u.behaviourLog.changeVisitNotesTime(e.dealUserId,t,n,e.accessToken,i)},l.updataBrowseEndTime=function(e,i){var e=this,t=e.log_id,o=e.view_log_id,n=e.timeDifference,a={},r=(new Date).getTime()+n,d=new Date(r).format("yyyy-MM-dd hh:mm:ss");a.endTime=d,u.behaviourLog.changeBrowseNotesTime(e.dealUserId,t,o,a,e.accessToken,i)},l.webBehaviorInformation=function(e,i,t){var o=this,a=c.uuid(),r=o.log_id,d=o.view_log_id,s=o.timeDifference,l=(new Date).getTime(),g=new Date(l+s).format("yyyy-MM-dd hh:mm:ss");t&&(t=JSON.stringify(t));var m={action:e,description:i,start_time:g,end_time:g,content:t},f=function(e,i){n.debug(i),o.keyBehaviourIds[a]=i.id};return u.behaviourLog.webBehaviourInformation(o.dealUserId,r,d,m,o.accessToken,f),a},l.updataWebBehaviorEndTime=function(e){var i=this,t=i.log_id,o=i.view_log_id,a=i.keyBehaviourIds[e],r=i.timeDifference,d=(new Date).getTime()+r,s=new Date(d+r).format("yyyy-MM-dd hh:mm:ss"),c={end_time:s},l=function(e,i){e||n.debug(i)};u.behaviourLog.webBehaviourUpdataEndTime(i.dealUserId,t,o,a,c,i.accessToken,l)},l.updataForVersions=function(){g.get("kuickDealBehaviourBrowse")&&g.set("kuickDealBehaviourBrowse","false"),g.get("kuickDealBehaviourVisit")&&g.set("kuickDealBehaviourVisit","false")},l.addPagIndex=function(e){var i="kuickDeal_pageIndex",t=0,o=void 0==e||e,n=g.get(i);n&&(t=parseInt(n)),t=t<0?0:t,o?t++:t--,g.set(i,t)},l.addWindowUnloadEvent=function(){var e=this;s(window).on("beforeunload",function(){console.log("关闭！"),e.addPagIndex(!1),g.set("kuickDeal_leaveTime",(new Date).getTime())})},l.getLeaveTimeDValue=function(){var e=0,i="kuickDeal_leaveTime",t=(new Date).getTime(),o=60;if(!g.get(i))return!0;e=parseInt(g.get(i));var n=(t-e)/1e3;return!(n<o)},e.exports=l},23:function(e,i,t){var o=t(2).sessionStore(),n=t(5),a=function(e){this.appKey=e};a.prototype.get=function(e){return o.get("kd_"+this.appKey+"_"+e)},a.prototype.set=function(e,i){var t=location.host.split("."),a={};if(n.behavior.domain&&t.length>=2){var r=t.pop(),d=t.pop(),s=d+"."+r;a.domain=s,a.path="/"}o.set("kd_"+this.appKey+"_"+e,i,a)},e.exports=a}});